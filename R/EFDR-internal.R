.Random.seed <-
c(403L, 398L, -2134905657L, -1855111752L, 166972970L, 1467775072L, 
-1498859853L, 479763053L, 595377157L, 163660332L, 1840943489L, 
577331534L, 2138069021L, -1062658046L, -1696104620L, -2049099982L, 
-2069746413L, -1023451882L, 395097730L, 1762306595L, 200221808L, 
-940607452L, -195575158L, 976163866L, -1160480784L, 1285769692L, 
-248856264L, 313634224L, -1575254940L, -2019319284L, -454525658L, 
-643066869L, -1729331930L, -629966439L, -794985622L, -1644099898L, 
-1860546537L, 1817586858L, 1443379390L, 534819673L, -1146626994L, 
1310765600L, 578151415L, 958927840L, 1540555672L, -1644147424L, 
1267795525L, -1756733339L, -1679125970L, 235656120L, -461253518L, 
500004243L, -1830869824L, -606353725L, -113477198L, -152410142L, 
1957849493L, 670715423L, -100085446L, -1782523959L, -342543685L, 
1682577122L, -353832670L, 259204464L, -453697817L, -584341720L, 
-445328926L, -1494663957L, -167134233L, 1288609356L, -1439824625L, 
-1392256998L, 1778521211L, 307492349L, -1186229792L, -983774221L, 
2125835059L, -360373079L, 1652707588L, 709284077L, -877292515L, 
951926391L, -327482699L, 213227764L, -112250240L, -722994807L, 
852804060L, -1012688232L, 614621424L, -1377434733L, -1659167521L, 
-1918965500L, 1365025100L, -1783367635L, 1590189708L, 920708818L, 
1407809252L, -1342122872L, -12061569L, 1702540543L, -1951230569L, 
-1832965729L, -2101406626L, 423845240L, -1172340193L, 957884604L, 
-532751615L, 1771421186L, 116452644L, -293160837L, -99828211L, 
-1801916656L, -1302664383L, -1650533300L, 1591238472L, -2146814763L, 
288163424L, -810682766L, -123609598L, 387295502L, 33118241L, 
1212381925L, 1913220966L, 1145022695L, 1121884307L, 1791335893L, 
-1746375723L, -2048018711L, 372302524L, 2048570113L, 721690225L, 
141282066L, -1054832107L, 907738332L, 731681779L, -1622572045L, 
-1813492736L, -274928424L, -1497810948L, 88141693L, 1997846446L, 
-128436155L, 23933514L, -589288921L, -890515791L, 1292596578L, 
-1096790640L, -2038024767L, 1499151237L, -772773281L, 603497932L, 
1202980710L, 1467726257L, 480021222L, -2741245L, 356119285L, 
846845221L, 1250232102L, -513828923L, -825318073L, -2037672412L, 
239786352L, -937998679L, -1792182094L, 945411758L, 570813402L, 
1964600010L, -291348075L, 1766577629L, 65834140L, -60646125L, 
-1476552141L, -259854105L, -1762164494L, -1345390552L, -1489615736L, 
-787307136L, 196555028L, -795282406L, -1971914462L, -558711265L, 
1290875315L, 1745227549L, 642292439L, -2035444450L, 770308786L, 
1908822939L, 286709859L, 1875722992L, 1314122315L, -1034022561L, 
-1753040212L, -1051535669L, -529646743L, 270843379L, -58794816L, 
933714206L, 692352063L, 471385496L, 40777911L, 25628722L, 2002912630L, 
800525145L, -1618257771L, -522353727L, 388170829L, 1225852983L, 
-756140866L, -836545143L, 1572222412L, -302690825L, 75988381L, 
-1531862537L, 1217132025L, -6825393L, -487187082L, -1254433654L, 
1977558490L, 734350976L, 255172479L, -763763504L, -1507265199L, 
-1874055179L, 1654084618L, -1443359572L, 1646430573L, 1890656432L, 
69639612L, 2120342454L, -1600003895L, -1931878139L, -175804990L, 
-948817079L, 1115793018L, -344931178L, 530616967L, 1518205028L, 
293251625L, 1016511064L, -1713574977L, 350395537L, -1406352551L, 
1393747839L, -918260892L, -851521067L, 835295870L, -92709259L, 
-2051907389L, -1020304715L, -1905276207L, -1681811461L, -1466424724L, 
365245033L, -1434102579L, -1286895435L, -1414922660L, -1126440297L, 
175523714L, -1796256741L, -1616642280L, 1113038806L, -641459878L, 
-915122483L, 432443766L, -1850886118L, -1557384834L, -629160173L, 
1043828541L, -1473151311L, 1419208774L, -1189246628L, 414303526L, 
2107394113L, -1275881777L, -1486808735L, -158757210L, 1674280255L, 
1354201705L, -1417903486L, 1157780615L, 1373139484L, 1131678494L, 
-352977113L, -507394401L, 1975789120L, -1678870645L, 2144102371L, 
1008567404L, -1399327072L, 197310430L, -198340638L, 491853919L, 
1284302968L, -475727450L, -661873649L, 874108393L, 1139817407L, 
-284833855L, 1872912926L, 2142067654L, -800297900L, -1356315912L, 
849749972L, -610264764L, -1526548447L, 328978994L, 1205424470L, 
882459734L, -726417100L, 2126326658L, 1153474035L, 132104278L, 
-1353329049L, -834255665L, -1537995965L, -1093678822L, 567477933L, 
346840155L, -415359144L, 1279684626L, 92995312L, 1585052371L, 
1179255524L, -161767730L, 764869329L, -963119755L, -2036357553L, 
1922208257L, 614943082L, -640293007L, -882636161L, 1916566479L, 
1211327937L, 2009729835L, -524572297L, -1470015718L, 747144924L, 
168217942L, -976423094L, 1488181323L, -367757982L, -2047861115L, 
-842738325L, -2110550650L, 419753272L, -874913593L, 43292175L, 
385400975L, -86958153L, 662209330L, 1984078957L, -1907981480L, 
1977568558L, 321324854L, 144367218L, 1226792283L, 883201595L, 
1562543434L, -902722227L, 2059082989L, -2003327276L, -1323732195L, 
-855308180L, -1046346915L, -252364052L, -1628674091L, -2130781886L, 
-1489509975L, -1716150650L, 1260640510L, 748283236L, -1146660328L, 
-1620349012L, 1490990082L, -1481286433L, 1699953860L, 1546757842L, 
1267623646L, 597957856L, -1730846711L, -163733300L, 1330322191L, 
2101700405L, 387835862L, -419216118L, 1993721560L, -220427616L, 
1510203720L, 713960406L, -1923478209L, 1431467358L, -1479308747L, 
-1044277016L, 1718659483L, 848726224L, 988662295L, 532716126L, 
1154692686L, 1647214767L, -935986850L, 1368208948L, 1400489383L, 
1489367998L, -117671300L, 471011251L, 14237912L, 1302748685L, 
788914916L, 1034366880L, -288700037L, -1254373771L, -263301589L, 
-1798092632L, -762051299L, 650308898L, 1618170720L, -1454352136L, 
-927175159L, -162337443L, -1303140891L, 648399019L, 788201063L, 
-986494308L, -638950641L, 423323932L, -374324753L, 1178373677L, 
-1691986661L, 575331967L, -1357270729L, -1129631307L, -411967729L, 
-1952310371L, 1212492519L, -83498278L, -968096818L, 1969262186L, 
30196278L, 1065183331L, 48699840L, 1683728698L, 1955705898L, 
2074452569L, -1155729929L, 530490595L, 1233357670L, -499280907L, 
1709095568L, 415199929L, -144240543L, -2093082609L, 1382469452L, 
-1896395458L, 1227532958L, -910379508L, -473225904L, 1573281943L, 
-1100354612L, -2044410627L, -279048940L, -514160978L, 1798017109L, 
-1775077150L, 2035004262L, 192253480L, 552193101L, -1331029239L, 
298077700L, 1881002102L, -1649142976L, -1140698382L, -650311612L, 
2040360187L, -1762678725L, 1006508537L, 83214914L, 1725282666L, 
-425077141L, -1959620704L, 274178581L, -494875600L, 1587460846L, 
240886934L, 400842460L, -752474401L, -1266283103L, 779146837L, 
-1829063183L, 1687751273L, 1860713044L, -875112097L, 2083151383L, 
728605693L, 279118936L, -562447352L, 715310507L, 630421403L, 
1580309152L, 1365959834L, 748975905L, 333764628L, -1816653185L, 
1905207267L, 2115185266L, 906561610L, 1073102070L, 283467725L, 
-228469866L, -1610954099L, 1809721641L, 2046952060L, -2119077338L, 
-2060778966L, -1051110499L, -1138422350L, -920649161L, 482620392L, 
753903790L, 1845988958L, -389508005L, -1385083688L, 1572375464L, 
2086774819L, 2121261953L, 1137603711L, -1883420655L, 302727991L, 
717715901L, -711576072L, 620346679L, 742970748L, 1021437545L, 
-1514538L, 1697938029L, -1121299285L, 601421787L, -1140267359L, 
1696255896L, 1249862578L, 1558413489L, -126384442L, 2042370415L, 
1711448861L, -1007667837L, -1474076155L, -2048217106L, 774262571L, 
-1463073799L, 1310622746L, -1540268980L, 231172449L, 717573137L, 
196839998L, 1776856583L, 646566900L, -418693144L, 2138857301L, 
-270913518L, 1326606833L, 913693391L, -1686062407L, -1094550307L, 
-977429854L, -474439126L, 1351578335L, -1756608548L, -1048786617L, 
78373426L, -1629440667L, 1135653852L, -311162179L, -1710474896L, 
1462504468L, -27285748L, 209547880L, -525552621L, -700096617L, 
-1937189341L, -775179639L, -762280666L, 2089496156L, 47902021L, 
-982875058L, -686415161L, -979709698L, 1349951085L, -198838025L, 
-881594552L, 819030374L, 744433672L, 1955944794L, 605164910L, 
-164788041L, -803937229L, 1650112895L, 317655554L, 1125901269L, 
757934311L, -2098136980L, -637215927L, -102855918L, 848678564L, 
1329317607L, -1319976799L, -403147142L, 1305507890L, -1207376323L, 
-1383825672L, -1700514853L, 613781911L, -656391383L, 1896078759L, 
-667208749L, -1450284506L, 442514711L, -367749426L, -1281679116L, 
1237105438L, 1333678013L, 2098856525L, 30852262L, 1337556966L, 
-1643437329L, -1931931790L, 1856417515L, -1149647341L)
.check_args <-
function(Z,wf="la8",J=3,alpha = 0.05,n.hyp = 1L,b = 11L,nei = NULL) {
  if(!is.matrix(Z)) stop("Z needs to be an n x n matrix")
  if(!(ncol(Z) == nrow(Z))) stop("Z needs to be square")
  if(!(IsPowerOfTwo(ncol(Z))) |  !(IsPowerOfTwo(nrow(Z)))) stop("Z needs to have rows and columns a power of two")
  temp <- tryCatch({
    wave.filter(wf)
  }, error = function(e) {
    stop("Invalid filter specification. Refer to waveslim::wave.filter for filter names")
  })
  if(!((J %% 1 == 0)  & J > 0 )) stop("J needs to be an integer greater than zero")
  if(!(class(dwt.z) == "dwt.2d")) stop("dwt.z needs to be a dwt.2d object generated by functions in the waveslim package")
  if(!(alpha > 0 & alpha < 1)) stop("alpha needs to be less than 1 and greater than 0")
  if(!(all(n.hyp > 0) & all(n.hyp %% 1 == 0))) stop("n.hyp needs to be an integer vector with all elements greater than zero")
  if(!((b %% 1 == 0)  & b > 0 )) stop("b needs to be an integer greater than zero")
  if(!(is.null(nei))) {
    if(!is.matrix(nei)) stop("nei needs to be a matrix or NULL")
    if(!all(dim(nei) == c(length(unlist(dwt.z)),b))) stop("nei needs to be of the correct dimensions (n x b)")
  }
}
.flat.pack <-
function(dwt,b=11) {
  
  M <- 3
  J <- (length(dwt)-1)/M
  K1 <- K2 <- nrow(dwt.z[[1]])
  
  min_n <- K1*2^{-(J-1)}
  layers <- list()
  for (j in J:1) {# start from coarsest resolution and go down to the finest
    n <- K1*2^{-(j-1)}
    ## Set up comparison table
    s <- seq(0,(min_n+1),,n+2)[-c(1,(n+2))]
    grid_points <- expand.grid(s,s)
    k_points <- expand.grid(1:n,1:n)
    layers[[j]] <- data.frame(k1 = k_points[,1], k2 = k_points[,2], s1 =  grid_points[,1], s2 = grid_points[,2],m = 1,j=j)
    layers_temp <- layers[[j]]
    for( m in 2:M) {
      layers_temp$m <- m
      layers[[j]] <- rbind(layers[[j]],layers_temp)
    }
    # If we also need to include the scaling function coefficients
    if (j == J) {
      layers[[j]] <- rbind(layers[[j]],data.frame(k1 = k_points[,1], k2 = k_points[,2], s1 =  grid_points[,1], s2 = grid_points[,2],m = 4,j=j))
    }
  } 
  
  layers <- Reduce("rbind",layers)
}
.jmk.dist <-
function(j,m,k1,k2,j_,m_,s1,s2) {
  d1 <- (j > j_) + sqrt((k1 - s1)^2 + (k2 - s2)^2) + 1 - (m == m_)
  #d1 <- j - j_ + sqrt((k1 - s1)^2 + (k2 - s2)^2) + 1 - (m == m_)
}
.jmk.sys <-
function(dwt) {
  
  M <- 3
  J <- (length(dwt)-1)/M
  K1 <- K2 <- nrow(dwt[[1]])
  
  dwt.t <- array(NA,dim=c(J,M+1,K1,K1))
  for (j in 1:J) 
    for(m in 1:M){
      dwt.partial <- dwt[[(j-1)*M + m]]
      n <- K1*2^{-(j-1)}
      dwt.t[j,m,1:n,1:n] <- dwt.partial
    }
  dwt.t[J,M+1,1:n,1:n] <- dwt[[J*M + 1]]
  dwt.t
  
}
.lapply.dwt <-
function(x,f) {
  x2 <- lapply(x, f)
  attr(x2, "J") <- attributes(x)$J
  attr(x2, "wavelet") <- attributes(x)$wavelet
  attr(x2, "boundary") <- attributes(x)$boundary
  attr(x2, "class") <- c("dwt.2d")
  x2
}
.p.values <-
function(dwt) {
  .lapply.dwt(dwt,function(x) {
    2*(1-pnorm(abs(x)))
  } )
  
}
.reconstruct.wt <-
function(dwt,keep) {
  
  z_unlist <- unlist(dwt)
  if (length(keep) == 0 ) {
    z_unlist <- z_unlist * 0
  } else {
    z_unlist[-keep] <- 0
  }
  .relist.dwt(z_unlist,dwt)
  
}
.relist.dwt <-
function(vec,x) {
  x2 <- relist(vec,as(x,"list"))
  attr(x2, "names") <- names(x)
  attr(x2, "J") <- attributes(x)$J
  attr(x2, "wavelet") <- attributes(x)$wavelet
  attr(x2, "boundary") <- attributes(x)$boundary
  attr(x2, "class") <- c("dwt.2d")
  x2
}
.std.wav.coeff <-
function(dwt) {
  .lapply.dwt(dwt,function(x) {
    std <- mad(x)
    x/std
  })  
}
.weights.efdr <-
function(dwt) {
  weight <- dwt
  n <- nrow(weight[[1]])
  
  for(i in 1:3){
    temp <- array(0,c(12,n,n))
    temp[1,,] <- dwt[[i]][c(2:n,1),]^2
    temp[2,,] <- dwt[[i]][c(n,1:(n-1)),]^2
    temp[3,,] <- dwt[[i]][,c(2:n,1)]^2
    temp[4,,] <- dwt[[i]][,c(n,1:(n-1))]^2
    temp[5,,] <- dwt[[i]][c(2:n,1),c(2:n,1)]^2
    temp[6,,] <- dwt[[i]][c(n,1:(n-1)),c(n,1:(n-1))]^2
    temp[7,,] <- dwt[[i]][c(n,1:(n-1)),c(2:n,1)]^2
    temp[8,,] <- dwt[[i]][c(2:n,1),c(n,1:(n-1))]^2
    temp[9,,] <- kronecker(dwt[[i+3]]^2,matrix(1,2,2))
    temp[10,,] <- dwt[[1]]^2
    temp[11,,] <- dwt[[2]]^2
    temp[12,,] <- dwt[[3]]^2
    temp[i+9,,] <- matrix(0,n,n)
    weight[[i]] <- apply(temp,c(2,3),max)
  }
  
  
  n <- nrow(weight[[4]])
  for(i in 4:6){
    temp <- array(0,c(12,n,n))
    temp[1,,] <- dwt[[i]][c(2:n,1),]^2
    temp[2,,] <- dwt[[i]][c(n,1:(n-1)),]^2
    temp[3,,] <- dwt[[i]][,c(2:n,1)]^2
    temp[4,,] <- dwt[[i]][,c(n,1:(n-1))]^2
    temp[5,,] <- kronecker(dwt[[i+3]]^2,matrix(1,2,2))
    temp[6,,] <- dwt[[i-3]][2*(1:n)-1,2*(1:n)-1]^2
    temp[7,,] <- dwt[[i-3]][2*(1:n)-1,2*(1:n)]^2
    temp[8,,] <- dwt[[i-3]][2*(1:n),2*(1:n)-1]^2
    temp[9,,] <- dwt[[i-3]][2*(1:n),2*(1:n)]^2
    temp[10,,] <- dwt[[4]]^2
    temp[11,,] <- dwt[[5]]^2
    temp[12,,] <- dwt[[6]]^2
    temp[i+6,,] <- matrix(0,n,n) ### AGAIN REMOVING THE LOCAL NODE... WHY??
    weight[[i]] <- apply(temp,c(2,3),max)
  }
  
  n <- nrow(weight[[7]])
  for(i in 7:9){
    temp <- array(0,c(12,n,n))
    temp[1,,] <- dwt[[i]][c(2:n,1),]^2
    temp[2,,] <- dwt[[i]][c(n,1:(n-1)),]^2
    temp[3,,] <- dwt[[i]][,c(2:n,1)]^2
    temp[4,,] <- dwt[[i]][,c(n,1:(n-1))]^2
    temp[5,,] <- dwt[[i-3]][2*(1:n)-1,2*(1:n)-1]^2
    temp[6,,] <- dwt[[i-3]][2*(1:n)-1,2*(1:n)]^2
    temp[7,,] <- dwt[[i-3]][2*(1:n),2*(1:n)-1]^2
    temp[8,,] <- dwt[[i-3]][2*(1:n),2*(1:n)]^2
    temp[9,,] <- dwt[[7]]^2
    temp[10,,] <- dwt[[8]]^2
    temp[11,,] <- dwt[[9]]^2
    temp[12,,] <- dwt[[10]]^2
    temp[i+2,,] <- matrix(0,n,n)
    weight[[i]] <- apply(temp,c(2,3),max)
  }
  
  ### Replace coefficients with largest order statistics of neighbours
  ### PROBLEM: WHY ISN'T THE NODE IN QUESTION CONSIDERED??
  temp <- array(0,c(12,n,n))
  temp[1,,] <- dwt[[10]][c(2:n,1),]^2 # neighbours below
  temp[2,,] <- dwt[[10]][c(8,1:(n-1)),]^2 # neighbours to the left
  temp[3,,] <- dwt[[10]][,c(2:n,1)]^2 # neighbours to the right
  temp[4,,] <- dwt[[10]][,c(n,1:(n-1))]^2 # neighbours above
  temp[5,,] <- dwt[[10]][c(2:n,1),c(2:n,1)]^2 # neighbours bottom right
  temp[6,,] <- dwt[[10]][c(2:n,1),c(n,1:(n-1))]^2 # neighbours bottom left
  temp[7,,] <- dwt[[10]][c(n,1:(n-1)),c(2:n,1)]^2 # neighbours top right
  temp[8,,] <- dwt[[10]][c(n,1:(n-1)),c(n,1:(n-1))]^2 # neighbours top left
  temp[9,,] <- dwt[[7]]^2  # same scale different orientation
  temp[10,,] <- dwt[[8]]^2 # same scale different orientation
  temp[11,,] <- dwt[[9]]^2 # same scale different orientation
  weight[[10]] <- apply(temp,c(2,3),max) # maximum from all neighbours
  
  weight[[10]] <- weight[[10]]/weight[[10]] * 1e10 # Set v(0) to infinity as in paper
  
  weight
  
}
.weights.efdr2 <-
function(dwt,b=11) {
  
  ## Put into j,m,k1,k2 coordinate system
  M <- 3
  J <- (length(dwt)-1)/M
  K1 <- K2 <- nrow(dwt.z[[1]])
  
  dwt.t <- array(NA,dim=c(J,M+1,K1,K1))
  for (j in 1:J) 
    for(m in 1:M){
      dwt.partial <- dwt[[(j-1)*M + m]]
      n <- K1*2^{-(j-1)}
      dwt.t[j,m,1:n,1:n] <- dwt.partial
    }
  
  dwt.t[J,M+1,1:n,1:n] <- dwt[[J*M + 1]]
  
  weight <- dwt.t * 0
  for (j in J:1) {# start from coarsest resolution and go down to the finest
    n <- K1*2^{-(j-1)}
    
    ## Set up comparison table
    grid_points1 <- expand.grid(1:n,1:n)
    grid_points2 <- expand.grid(1:(2*n),1:(2*n))
    grid_points3 <- expand.grid(1:(n/2),1:(n/2))
    
    layers <- data.frame(k1 =  grid_points1[,1], k2 = grid_points1[,2],m = 1,j=j)
    layers <- rbind(layers,data.frame(k1 =  grid_points2[,1], k2 = grid_points2[,2],m = 1,j=j-1))
    layers <- rbind(layers,data.frame(k1 =  grid_points3[,1], k2 = grid_points3[,2],m = 1,j=j+1))
    layers_temp <- layers
    for( m in 2:M) {
      layers_temp$m <- m
      layers <- rbind(layers,layers_temp)
    }
    
    # If we also need to include the scaling function coefficients
    if (j == J) {
      layers <- rbind(layers,data.frame(k1 =  grid_points1[,1], k2 = grid_points1[,2],m = 4,j=j))
    }
    if (j == (J-1)) {
      layers <- rbind(layers,data.frame(k1 =  grid_points3[,1], k2 = grid_points3[,2],m = 4,j=j + 1))
    }
    
    layers <- subset(layers, j %in% 1:J)
    
    layers2 <- ddply(layers,"j",function(df) {
      if (df$j[1] == j){
        df$s1 = df$k1
        df$s2 = df$k2
      } else if(df$j[1] == (j - 1)) {
        df$s1 = (df$k1 + 1)/2
        df$s2 = (df$k2 + 1)/2
      } else {
        df$s1 = 2*df$k1 - 1
        df$s2 = 2*df$k2 - 1
      }
      return(df)
    })
    
    for (m in 1:M)
      for(k1 in 1:n)
        for(k2 in 1:n) {
          this_k1 <- k1; this_k2 <- k2
          L <- subset(layers2, abs(this_k1-s1) < 2.5 & abs(this_k2-s2) < 2.5)
          L$D1 <- .jmk.dist(j,m,k1,k2,L$j,L$m,L$s1,L$s2)
          max.set <- L[order(L$D1),][2:(b+1),]
          weight[j,m,k1,k2] <- max(dwt.t[cbind(max.set$j,max.set$m,max.set$k1,max.set$k2)]^2)
        }
  }
  weight[J,M+1,,] <- 1e10
  
  
  weight.list <- dwt
  for (j in 1:J) 
    for(m in 1:M){
      n <- K1*2^{-(j-1)}
      weight.list[[(j-1)*M + m]] <- weight[j,m,1:n,1:n]
    }
  weight.list[[J*M + 1]] <- weight[J,M+1,1:n,1:n]
  
  
  weight.list
}
.weights.efdr3 <-
function(dwt,nei,b=11) {
  
  M <- 3
  J <- (length(dwt)-1)/M
  K1 <- K2 <- nrow(dwt[[1]])
  
  dwt.t <- .jmk.sys(dwt)
  weight <- dwt.t * 0
  layers <- .flat.pack(dwt,b=b)
  
  layers$z <- dwt.t[as.matrix(subset(layers,select=c("j","m","k1","k2")))]^2
  weight_mat <- matrix(layers$z[c(nei)],nrow = nrow(layers))
  layers$weight <- apply(weight_mat,1,max)
  weight[cbind(layers$j,layers$m,layers$k1,layers$k2)] <- layers$weight
  weight[J,M+1,,] <- 1e10
  
  ## Set to original form
  weight.list <- dwt
  for (j in 1:J) 
    for(m in 1:M){
      n <- K1*2^{-(j-1)}
      weight.list[[(j-1)*M + m]] <- weight[j,m,1:n,1:n]
    }
  weight.list[[J*M + 1]] <- weight[J,M+1,1:n,1:n]
  
  weight.list
}
